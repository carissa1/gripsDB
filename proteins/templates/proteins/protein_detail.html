{% extends "base.html" %}
{% load static %}

{% block title %}{{ protein.name  }} :: Fluorescent Protein Database {% endblock %}

{% block vendorcss %}
    <link href="https://cdnjs.cloudflare.com/ajax/libs/nvd3/1.8.6/nv.d3.min.css" rel="stylesheet">
{% endblock vendorcss %}
{% block container-class %}container protein{% endblock %}

{% block content %}

		<div class="container">
			<div class="row">
				<div class="col-10 offset-sm">
					<h1 class="name display-4">{{ protein.name }}</h1>
				</div>
				<div class="col-1">
					<i class="fa{% if not request.user.is_authenticated %}r{% endif %} fa-star favorite align-self-bottom"></i>
				</div>
			</div>
		</div>

		<div class="spectra">
			{% if protein.has_spectra %}<div id="spectra"></div>{% endif %}
		</div>

		<div class="attributes">
			<h3>Attributes</h3>
			<div class="table-bordered">
				<table class="table table-striped mobile">
					<thead>
						<tr class="table-header">
							{% if protein.states.count > 1 %}
							<th>State</th>
							{% endif %}
							<th>Ex &lambda;</th>
				  			<th>Em &lambda;</th>
				  			<th>EC</th>
				  			<th>QY</th>
				  			<th class='d-none d-md-block'>Brightness</th>
				  			<th>pKa</th>
						</tr>
					</thead>
					<tbody>
					{% for state in protein.states.all %}
						<tr >
							{% if protein.states.count > 1 %}
							<td data-title="State">{{ state.name }}</td>
							{% endif %}
							<td data-title="Ex &lambda;">{{ state.ex_max | default:"&nbsp;" }}</td>
				  			<td data-title="Em &lambda;">{{ state.em_max | default:"&nbsp;"}}</td>
				  			<td data-title="EC">{{ state.ext_coeff | default:"&nbsp;"}}</td>
				  			<td data-title="QY">{{ state.qy | default:"&nbsp;"}}</td>
				  			<td data-title="Brightness" class='d-none d-md-block'>{{ state.brightness | default:"&nbsp;"}}</td>
				  			<td data-title="pKa">{{ state.pka | default:"&nbsp;"}}</td>
						</tr>
					{% endfor %}
					</tbody>
				</table>
			</div>
		</div>

		{% if protein.transitions.count > 0 %}
		<div class="attributes">
			<h3>Transitions</h3>
			<div class="table-bordered">
				<table class="table table-striped mobile">
					<thead>
						<tr class="table-header">
							<th>From</th>
				  			<th>To</th>
				  			<th>Switch &lambda;</th>
						</tr>
					</thead>
					<tbody>
					{% for t in protein.transitions.all|dictsort:"trans_wave" %}
						<tr >
							<td data-title="From State">{{ t.from_state.name | default:"&nbsp;"}}</td>
							<td data-title="To State">{{ t.to_state.name | default:"&nbsp;"}}</td>
							<td data-title="Switch &lambda;">{{ t.trans_wave | default:"&nbsp;" }}</td>
						</tr>
					{% endfor %}
					</tbody>
				</table>
			</div>
		</div>
		{% endif %}

		<div class="sequence">
			<h3>Amino Acid Sequence</h3>
			{% if protein.ipg_id %}
			<p>Identical Protein Group ID: <a href="https://www.ncbi.nlm.nih.gov/ipg/?term={{ protein.ipg_id }}[uid]">{{ protein.ipg_id }}</a></p>
			{% endif %}
			{% if protein.seq %}
				<div class='aminosequence container'>{{ protein.seq }}</div>
			{% else %}
			    <p>no sequence available ... <a href='#'>add one!</a></p>
			{% endif %}
		</div>

		<div class="primary-ref references">
			<h3>Primary Reference</h3>
			{% if protein.primary_reference %}
				{% include "_reference.html" with ref=protein.primary_reference %}
			{% endif %}
		</div>

		<div class="additional-ref references">
			<h3>Additional References</h3>
			<ol>
				{% for ref in protein.additional_references %}
					<li>{% include "_reference.html" %}</li>
				{% endfor %}
			</ol>
			<a href="#" data-toggle="tooltip" data-placement="right" title="Add a publication that references this fluorescent protein.  It does not need to be the paper that introduced the protein."><button class='btn btn-primary btn-sm'>Add Reference</button></a>

		</div>

	</div>
{% endblock content %}


{% block js-onpage %}
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js" charset="utf-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nvd3/1.8.6/nv.d3.min.js"> </script>
    <script src="{% static "js/nvd3spectra.js" %}"> </script>

    <script type="text/javascript">
    	$(function(){
    		$('[data-toggle="tooltip"]').tooltip()
    	})
    </script>

    {% if protein.has_spectra %}
        <script type="text/javascript">
            var myData = {{ protein.spectra|safe }};
            var chart = nv.models.lineChart();
            svg = d3.select('#spectra').append('svg');
            chart.options({
                margin: {left:20},
                noData: "Unable to load data...",
                transitionDuration: 200,
                showLegend: false,
                showXAxis: true,
                showYAxis: false,
                useInteractiveGuideline: true,
                forceY: [0,1.04],
                forceX: [350, 750],
            });

            /*These lines are all chart setup.  Pick and choose which chart features you want to utilize. */
            nv.addGraph(function() {
                chart.xAxis     //Chart x-axis settings
                //.axisLabel('Wavelength (nm)')
                .tickFormat(d3.format(',r'));

                // chart.yAxis     //Chart y-axis settings
                //   .axisLabel('Normalized Ex/Em')
                //   .tickFormat(d3.format('1%'));

                svg.datum(myData)         //Populate the <svg> element with chart data...
                .call(chart);	       //Finally, render the chart!

                //Update the chart when window resizes.
                nv.utils.windowResize(function() { chart.update() });
                return chart;
            });
        </script>
    {% endif %}
{% endblock %}



